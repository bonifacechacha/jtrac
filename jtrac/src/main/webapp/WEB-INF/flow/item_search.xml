<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE flow PUBLIC "-//SPRING//DTD WEBFLOW 1.0//EN"
    "http://www.springframework.org/dtd/spring-webflow-1.0.dtd">

<flow start-state="checkIfDashboardSearch">  
    
    <input-mapper>
        <mapping source="calledByRelate" target="flowScope.calledByRelate"/>
        <mapping source="relatingItem" target="flowScope.relatingItem"/>
    </input-mapper>   
    
    <decision-state id="checkIfDashboardSearch">
        <if test="${requestParameters.type == null}" then="itemSearchForm" else="itemListViewSetup"/>
    </decision-state>
    
    <action-state id="itemListViewSetup">
        <action bean="itemSearchFormAction" method="setupForm"/>            
        <transition on="success" to="itemListView">
            <action bean="itemSearchFormAction" method="itemListViewSetup"/>
            <action bean="itemSearchFormAction" method="itemSearchFormHandler"/>
        </transition>
    </action-state>
    
    <view-state id="itemSearchForm" view="item_search_form">
        <entry-actions>
            <action bean="itemSearchFormAction" method="setupForm"/>
        </entry-actions>
        <transition on="search" to="itemListView">
            <action bean="itemSearchFormAction" method="bind"/>
            <action bean="itemSearchFormAction" method="itemSearchFormHandler"/>
        </transition>
        <transition on="view" to="itemViewForm">            
            <action bean="itemSearchFormAction" method="itemSearchViewByRefIdHandler"/>
        </transition>
        <transition on="back" to="backFromSearch"/>      
    </view-state>    
    
    <view-state id="itemListView" view="item_list">
        <transition on="page" to="itemListView">
            <action bean="itemSearchFormAction" method="itemSearchPageHandler"/>
        </transition>
        <transition on="view" to="itemViewForm">            
            <action bean="itemSearchFormAction" method="itemSearchViewByIdHandler"/>
        </transition>
        <transition on="back" to="itemSearchForm">
            <action bean="itemSearchFormAction" method="itemSearchBackHandler"/>
        </transition>
    </view-state>
    
    <subflow-state id="itemViewForm" flow="item_view">
        <attribute-mapper>
            <input-mapper>                
                <!-- just for displaying navigation in header.jsp -->
                <mapping source="flowScope.space" target="space"/>
                <mapping source="flowScope.itemSearch" target="itemSearch"/>
                <!-- just for enabling "back" navigation in item_view_form.jsp -->
                <mapping source="requestScope.calledBySearch" target="calledBySearch"/>
                <!-- just for disabling "relate" navigation in item_view_form.jsp -->
                <mapping source="flowScope.calledByRelate" target="calledByRelate"/>
                <mapping source="flowScope.relatingItem" target="relatingItem"/>
            </input-mapper>
        </attribute-mapper>
        <transition on="itemListView" to="itemListView">
            <action bean="itemSearchFormAction" method="itemSearchFormHandler"/>
        </transition>
        <transition on="relateSubmit" to="relateSubmit"/>       
    </subflow-state>      
    
    <end-state id="relateSubmit"/>
        
</flow>

